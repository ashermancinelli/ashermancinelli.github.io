<!DOCTYPE html>
<html>
  <head>
    <title>Spack for Package Development Part 3 – Asher Mancinelli – compilers, coffee, etc</title>

        <meta charset="utf-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    
    <meta name="description" content="Third in this series, this post focuses on leveraging environments for debugging and reproducing errors.
">
    <meta property="og:description" content="Third in this series, this post focuses on leveraging environments for debugging and reproducing errors.
">
    
    <meta name="author" content="Asher Mancinelli">

    
    <meta property="og:title" content="Spack for Package Development Part 3">
    <meta property="twitter:title" content="Spack for Package Development Part 3">
    

    <link rel="icon" href="/images/chip.png">


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="alternate" type="application/rss+xml" title="Asher Mancinelli - compilers, coffee, etc" href="/feed.xml">

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://raw.githubusercontent.com/ashermancinelli/ashermancinelli.github.io/master/images/chip.png"></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Asher Mancinelli</a></h1>
            <p class="site-description">compilers, coffee, etc</p>
          </div>

          <nav>
            <a href="/">DevBlog</a>
            <a href="/about">About</a>
            <a href="/coffee">CoffeeBlog</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Spack for Package Development Part 3</h1>

  <div class="entry">
    <p>Third in this series, this post focuses on <em>leveraging environments for debugging and reproducing errors</em>.</p>

<font size="-1">
  <em>
    These views do not in any way represent those of NVIDIA or any other organization or institution that I am professionally associated with.
    These views are entirely my own.
  </em>
</font>

<p>In the <a href="/spack2">previous post about package development with Spack</a>, we discussed environment management with Spack, particularly integration with a private repository.
What are some of the benefits of this, other than onboarding new developers?</p>

<p>As we’ve developed our private spack repository, we’ve also added some spack environments along the way:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
floodsimulationrepo
├── environments
│   ├── jupiter
│   │   └── env.yaml
│   ├── saturn
│   │   └── env.yaml
│   └── osx
│       └── env.yaml
├── packges
│   ├── ipopt
│   │   └── package.py
│   └── floodsimulation
│       └── package.py
└── repo.yaml

</code></pre></div></div>

<p>In this post, we’re going to look at using this configuration to reproduce errors and coordinate development and debugging within a large team.</p>

<h3 id="reproducing-finicky-errors">Reproducing Finicky Errors</h3>

<p>Bugs relating to interfaces between libraries are sometimes the most difficult to track down.
To use an example from my experience, one of my teams was developing a library that builds on the optimization solver <a href="https://github.com/LLNL/hiop">HiOp</a>, which leverages CUDA, MAGMA, and many BLAS/LAPACK routines.
After developing some functionality tests to ensure our library was performing as expected, we noticed that on some platforms with certain CUDA devices and CUDA versions, our library was failing to converge within our expected tolerance.
For weeks we stepped through debuggers and discussed possibile issues with our codebase and the various libraries we depend on to no avail.</p>

<p>We eventually enlisted the help of collaborators from another laboratory to build and test our codebase under similar conditions on their platforms to ensure they were able to reproduce the bug.
In order to ensure our collaborators were able to accurately reproduce the environments in which we found the bug, we created and distributed spack environments specific to that development snapshot.</p>

<p>Continuing with our <code class="language-bash highlighter-rouge">FloodSimulation</code> example, let us imagine we found a bug when running with CUDA versions v11.0.104 through 11.1 and HiOp v0.3.0 on our imaginary cluster Jupiter, and would like other teammembers to reproduce the bug on differrent platforms but using the same stack.
We might create an environment file like so:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># reproduce-error.yaml</span>
<span class="na">spack</span><span class="pi">:</span>
  <span class="na">specs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">floodsimulation ^floodsimulationrepo.petsc ^floodsimulationrepo.hiop</span>
    <span class="s">^cuda@11.0.104 ^hiop@0.3.0</span>
  <span class="na">view</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">packages</span><span class="pi">:</span>
    <span class="na">cuda</span><span class="pi">:</span>
      <span class="na">versions</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">11.0.104</span><span class="pi">,</span> <span class="nv">11.1.0</span><span class="pi">]</span>
    <span class="na">hiop</span><span class="pi">:</span>
      <span class="na">versions</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0.3.0</span><span class="pi">]</span>

</code></pre></div></div>

<p>You can see we’ve established the exact matrix of libraries in which our bug manifests.
We then asked our collaborators to install all versions of this spack environment and attempt to reproduce our bug, with all certainty that they will accurately reproduce the environment.</p>

<p>We also tend to track these environments in our repository like so:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
floodsimulationrepo
├── environments
│   ├── jupiter
│   │   ├── env.yaml
│   │   └── reproduce-error.yaml &lt;<span class="nt">---</span>
│   ├── saturn
│   │   └── env.yaml
│   └── osx
│       └── env.yaml
├── packges
│   ├── ipopt
│   │   └── package.py
│   └── floodsimulation
│       └── package.py
└── repo.yaml

</code></pre></div></div>

<p>so that in future threads we are able to refer back to the exact configurations which caused bugs in the past.</p>

<p>With this strategy, we are able to maintain a reproducible and consistent software stack with robust coordination between teams.
Another potential use-case of this strategy is to coordinate profiling efforts - each month or so a spack environment which instantiates a development snapshot of the development stack may be distributed to profiling teams.
This way, the profiling team may work on a known working configuration of the software stack to identify performance bottlenecks while the core development team continues developing.</p>

<p><a href="/spack2">Previous in this Series</a></p>

<p><a href="/spack4">Next in this Series</a></p>

<h2> Contact </h2>

<p>You can reach me at any of the links below:</p>

<ul>
  <li><a target="_blank" href="https://www.youtube.com/c/AsherMancinelli">YouTube</a></li>
  <li><a target="_blank" href="https://www.linkedin.com/in/asher-mancinelli-bb4a56144/">LinkedIn</a></li>
  <li><a target="_blank" href="https://github.com/ashermancinelli">GitHub</a></li>
  <li><a target="_blank" href="mailto:ashermancinelli@gmail.com">Personal Email</a></li>
</ul>

<font size="-1">
  <em>
    These views do not in any way represent those of NVIDIA or any other organization or institution that I am professionally associated with.
    These views are entirely my own.
  </em>
</font>


  </div>

  <hr>

  <div class="date">
    Written on Mar 6th, 2021
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:ashermancinelli@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/ashermancinelli"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/https://www.linkedin.com/in/asher-mancinelli-bb4a56144/"><i class="svg-icon linkedin"></i></a>




<a href="https://youtube.com/channel/UCZ5sL4E662VP1ZwC4h85ttQ"><i class="svg-icon youtube"></i></a>

        </footer>
      </div>
    </div>
    
    <!--
    <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
    -->
    
    

  </body>
</html>
