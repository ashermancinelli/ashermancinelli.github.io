<!DOCTYPE html>
<html>
  <head>
    <title>A Look at std::mdspan – Asher Mancinelli – Mostly C++</title>

        <meta charset="utf-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    
    <meta name="description" content="New library feature coming to C++23
">
    <meta property="og:description" content="New library feature coming to C++23
">
    
    <meta name="author" content="Asher Mancinelli">

    
    <meta property="og:title" content="A Look at std::mdspan">
    <meta property="twitter:title" content="A Look at std::mdspan">
    

    <link rel="icon" href="/images/chip.png">


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="alternate" type="application/rss+xml" title="Asher Mancinelli - Mostly C++" href="/feed.xml">

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://raw.githubusercontent.com/ashermancinelli/ashermancinelli.github.io/master/images/chip.png"></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Asher Mancinelli</a></h1>
            <p class="site-description">Mostly C++</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>A Look at std::mdspan</h1>

  <div class="entry">
    <p>New library feature coming to C++23</p>

<font size="-1">
  <em>
    These views do not in any way represent those of NVIDIA or any other organization or institution that I am professionally associated with.
    These views are entirely my own.
  </em>
</font>

<h2 id="tensors">Tensors</h2>

<p>A YouTuber by the name of <a href="https://www.youtube.com/c/ContextFree/videos">Context Free</a> posted a few videos about tensors in various programming languages, including C++ (<a href="https://youtu.be/WbpbEilgQBc">first video</a>, <a href="https://youtu.be/ICxxKeE4GuA">second video</a>).
I loved these videos, but I noticed ContextFree failed to mention <code class="language-plaintext highlighter-rouge">std::mdspan</code>, a new library feature coming to C++23.</p>

<h2 id="stdmdspan"><code class="language-plaintext highlighter-rouge">std::mdspan</code></h2>

<p><code class="language-plaintext highlighter-rouge">std::mdspan</code> (or <code class="language-plaintext highlighter-rouge">std::experimental::mdspan</code> until the proposal is accepted-I’ll be using <code class="language-plaintext highlighter-rouge">stdex::mdspan</code>, as <code class="language-plaintext highlighter-rouge">stdex</code> is a common alias for <code class="language-plaintext highlighter-rouge">std::experimental</code>) is an alias for a more complex type, but at it’s core it is a pointer plus some number of <em>extents</em>.
<em>Extents</em> are either sizes of a given dimension on an <code class="language-plaintext highlighter-rouge">mdspan</code>, or the sentinal <code class="language-plaintext highlighter-rouge">std::dynamic_extent</code>, which indicates the extent is <em>dynamic</em>, and doesn’t have to be supplied at compile-time.
These extents and the sentinal <code class="language-plaintext highlighter-rouge">dynamic_extent</code> can be mixed and matched.
This powerful capability allows users to work with data as if it were a complex matrix structure while the underlying data remain linear.</p>

<p>For example, given raw data, an <code class="language-plaintext highlighter-rouge">mdspan</code> may be constructed and passed to some library that expects a matrix with rank 3:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://godbolt.org/z/eWKev9nas</span>
<span class="k">template</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="k">using</span> <span class="n">mat_3d</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">mdspan</span><span class="o">&lt;</span>
                 <span class="n">T</span><span class="p">,</span>
                 <span class="n">std</span><span class="o">::</span><span class="n">extents</span><span class="o">&lt;</span>
                     <span class="n">std</span><span class="o">::</span><span class="n">dynamic_extent</span>
                   <span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">dynamic_extent</span>
                   <span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">dynamic_extent</span>
                 <span class="o">&gt;</span>
               <span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="kt">void</span> <span class="nf">work</span><span class="p">(</span><span class="n">mat_3d</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">mat</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">raw</span><span class="p">[</span><span class="mi">500</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="n">work</span><span class="p">(</span><span class="n">stdex</span><span class="o">::</span><span class="n">mdspan</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
  <span class="n">work</span><span class="p">(</span><span class="n">stdex</span><span class="o">::</span><span class="n">mdspan</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
  <span class="n">work</span><span class="p">(</span><span class="n">stdex</span><span class="o">::</span><span class="n">mdspan</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that we will have to be more careful if we mix-and-match compile-time and run-time extents.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://godbolt.org/z/Phr1vh9zs</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="k">using</span> <span class="n">mat_3d</span> <span class="o">=</span> <span class="n">stdex</span><span class="o">::</span><span class="n">mdspan</span><span class="o">&lt;</span>
  <span class="n">T</span><span class="p">,</span>
  <span class="n">stdex</span><span class="o">::</span><span class="n">extents</span><span class="o">&lt;</span>
    <span class="n">stdex</span><span class="o">::</span><span class="n">dynamic_extent</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="n">stdex</span><span class="o">::</span><span class="n">dynamic_extent</span>
  <span class="o">&gt;</span>
<span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="kt">void</span> <span class="nf">work</span><span class="p">(</span><span class="n">mat_3d</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">mat</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">raw</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">work</span><span class="p">(</span><span class="n">mat_3d</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
  <span class="n">work</span><span class="p">(</span><span class="n">mat_3d</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
  <span class="c1">// work(mat_3d&lt;int&gt;(raw, 3, 0, 9)) will fail bc extents don't match!</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After supplying a dummy implementation of <code class="language-plaintext highlighter-rouge">work</code> to print the shape, we get</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">mat has shape [100, 5, 1]
mat has shape [4, 5, 5]
mat has shape [10, 1, 50]
</span></code></pre></div></div>

<p>In either case, the underlying data is the same, though it’s <em>viewed</em> differently in each of the invocations of <code class="language-plaintext highlighter-rouge">work</code>.
It’s no coincidence that <em>view</em> seems like a natural name for <code class="language-plaintext highlighter-rouge">mdspan</code> - <code class="language-plaintext highlighter-rouge">mdspan</code> was developed by the authors of the portable execution library Kokkos and inspired by the <code class="language-plaintext highlighter-rouge">Kokkos::View</code> type.</p>

<h2 id="subspans">Subspans</h2>

<p>Just like <code class="language-plaintext highlighter-rouge">std::span</code>, <code class="language-plaintext highlighter-rouge">mdspan</code> has support for taking subspans of a given span.
This is more complicated with <code class="language-plaintext highlighter-rouge">mdspan</code> however, due to <code class="language-plaintext highlighter-rouge">mdspan</code>’s variadic extents.</p>

<p>There are three ways to take a slice of an <code class="language-plaintext highlighter-rouge">mdspan</code>:</p>

<ol>
  <li>An integer index into the respective dimension</li>
  <li>A <code class="language-plaintext highlighter-rouge">std::tuple</code> or <code class="language-plaintext highlighter-rouge">std::pair</code> begin/end pair of indices</li>
  <li>The special value <code class="language-plaintext highlighter-rouge">std::full_extent</code> indicating all elements of the dimension should be selected in the subspan</li>
</ol>

<p>For example:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// https://godbolt.org/z/Wrr4dhEs8</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">raw</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="n">std</span><span class="o">::</span><span class="n">iota</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">raw</span><span class="o">+</span><span class="mi">27</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="c1">// full will have shape [3,3,3]</span>
  <span class="k">auto</span> <span class="n">full</span> <span class="o">=</span> <span class="n">stdex</span><span class="o">::</span><span class="n">mdspan</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">// sub will have shape [1,3] and values [18,19,20]</span>
  <span class="k">auto</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">stdex</span><span class="o">::</span><span class="n">submdspan</span><span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">stdex</span><span class="o">::</span><span class="n">full_extent</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that using a single value as an extent passed to <code class="language-plaintext highlighter-rouge">submdspan</code> squashes the dimension to 0, while passing a <code class="language-plaintext highlighter-rouge">pair</code> or <code class="language-plaintext highlighter-rouge">tuple</code> will keep the dimension around, even if that dimension is 1.
<code class="language-plaintext highlighter-rouge">pair</code>/<code class="language-plaintext highlighter-rouge">tuple</code> do not effect rank, while passing an index as an extent does.</p>

<p>I hope this article was enough to get you interested in <code class="language-plaintext highlighter-rouge">mdspan</code> and the future of C++!
Make sure to check out Daisy Hollman’s appearance on CppCast, Context Free’s YouTube channel, and the reference implementation of C++23’s <code class="language-plaintext highlighter-rouge">std::mdspan</code>.</p>

<h2> Contact </h2>

<p>You can reach me at any of the links below:</p>

<ul>
  <li><a target="_blank" href="https://www.youtube.com/c/AsherMancinelli">YouTube</a></li>
  <li><a target="_blank" href="https://www.linkedin.com/in/asher-mancinelli-bb4a56144/">LinkedIn</a></li>
  <li><a target="_blank" href="https://github.com/ashermancinelli">GitHub</a></li>
  <li><a target="_blank" href="mailto:ashermancinelli@gmail.com">Personal Email</a></li>
</ul>

<font size="-1">
  <em>
    These views do not in any way represent those of NVIDIA or any other organization or institution that I am professionally associated with.
    These views are entirely my own.
  </em>
</font>

<h2 id="links">Links</h2>

<ul>
  <li><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p0009r14.html"><code class="language-plaintext highlighter-rouge">mdspan</code> paper, revision 14</a></li>
  <li>Godbolt links:
    <ul>
      <li><a href="https://godbolt.org/z/eWKev9nas">Example 1</a></li>
      <li><a href="https://godbolt.org/z/Phr1vh9zs">Example 2</a></li>
      <li><a href="https://godbolt.org/z/Wrr4dhEs8">Example 3</a></li>
    </ul>
  </li>
  <li><a href="https://www.youtube.com/c/ContextFree/videos">ContextFree’s YouTube channel</a></li>
  <li><a href="https://github.com/kokkos/mdspan">Kokkos mdspan implementation</a></li>
  <li><a href="https://github.com/kokkos/mdspan/wiki/A-Gentle-Introduction-to-mdspan">Intro to mdspan wiki article</a></li>
  <li><a href="https://godbolt.org/z/KMT3G9Ese"><code class="language-plaintext highlighter-rouge">std::mdspan</code> on compiler explorer</a></li>
  <li><a href="https://cppcast.com/too-cute-mdspan/">CppCast episode with Daisy Hollman</a></li>
</ul>

  </div>

  <hr>

  <div class="date">
    Written on Dec 23rd, 2021
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:ashermancinelli@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/ashermancinelli"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/https://www.linkedin.com/in/asher-mancinelli-bb4a56144/"><i class="svg-icon linkedin"></i></a>




<a href="https://youtube.com/channel/UCZ5sL4E662VP1ZwC4h85ttQ"><i class="svg-icon youtube"></i></a>

        </footer>
      </div>
    </div>
    
    <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a>
</div>
    
    

  </body>
</html>
