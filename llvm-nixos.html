<!DOCTYPE html>
<html>
  <head>
    <title>LLVM Development on NixOS – Asher Mancinelli – Mostly C++ and Compilers</title>

        <meta charset="utf-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    
    <meta name="description" content="I’ve found NixOS to provide a wonderful development environment after learning a bit of the Nix language - but building and hacking on LLVM on NixOS gave me some trouble.
Hopefully reading this post will save you the trouble!
">
    <meta property="og:description" content="I’ve found NixOS to provide a wonderful development environment after learning a bit of the Nix language - but building and hacking on LLVM on NixOS gave me some trouble.
Hopefully reading this post will save you the trouble!
">
    
    <meta name="author" content="Asher Mancinelli">

    
    <meta property="og:title" content="LLVM Development on NixOS">
    <meta property="twitter:title" content="LLVM Development on NixOS">
    

    <link rel="icon" href="/images/chip.png">


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="alternate" type="application/rss+xml" title="Asher Mancinelli - Mostly C++ and Compilers" href="/feed.xml">

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://raw.githubusercontent.com/ashermancinelli/ashermancinelli.github.io/master/images/chip.png"></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Asher Mancinelli</a></h1>
            <p class="site-description">Mostly C++ and Compilers</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>LLVM Development on NixOS</h1>

  <div class="entry">
    <p>I’ve found NixOS to provide a wonderful development environment after learning a bit of the Nix language - but building and hacking on LLVM on NixOS gave me some trouble.
Hopefully reading this post will save you the trouble!</p>

<font size="-1">
  <em>
    These views do not in any way represent those of NVIDIA or any other organization or institution that I am professionally associated with.
    These views are entirely my own.
  </em>
</font>

<h1 id="build-environment">Build Environment</h1>

<h3 id="if-youd-just-like-to-see-my-config-go-to-the-end-of-the-post-where-ive-pasted-the-whole-thing"><strong><em>If you’d just like to see my config, go to the end of the post where I’ve pasted the whole thing</em></strong></h3>

<p>I’m no Nix language expert by any stretch of the imagination, nor am I an expert in dynamic linking or managing an operating system.</p>

<p>I started with the <code class="language-plaintext highlighter-rouge">nix-shell</code> example provided in <a href="https://nixos.wiki/wiki/LLVM">the nix documentation here</a> and made additions as I found the need.</p>

<p>I had to pass the library directories of both GCC and GLIBC using both the <code class="language-plaintext highlighter-rouge">-B</code> and <code class="language-plaintext highlighter-rouge">-L</code> flags, because some required object files (like <code class="language-plaintext highlighter-rouge">crt1.o</code>) must be found at link time, and clang/gcc don’t search <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> for these files.
<code class="language-plaintext highlighter-rouge">-B</code> will tell the compilers to look in the provided paths for these files.</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">libcFlags</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"-L </span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="o">.</span><span class="nv">libc</span><span class="si">}</span><span class="s2">/lib"</span>
    <span class="s2">"-B </span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="o">.</span><span class="nv">libc</span><span class="si">}</span><span class="s2">/lib"</span>
  <span class="p">];</span>

  <span class="c"># The string version of just the gcc flags for NIX_LDFLAGS</span>
  <span class="nv">nixLd</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"-L </span><span class="si">${</span><span class="nv">gccForLibs</span><span class="si">}</span><span class="s2">/lib"</span>
    <span class="s2">"-L </span><span class="si">${</span><span class="nv">gccForLibs</span><span class="si">}</span><span class="s2">/lib/gcc/</span><span class="si">${</span><span class="nv">targetPlatform</span><span class="o">.</span><span class="nv">config</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">gccForLibs</span><span class="o">.</span><span class="nv">version</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">];</span>

  <span class="nv">gccFlags</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"-B </span><span class="si">${</span><span class="nv">gccForLibs</span><span class="si">}</span><span class="s2">/lib/gcc/</span><span class="si">${</span><span class="nv">targetPlatform</span><span class="o">.</span><span class="nv">config</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">gccForLibs</span><span class="o">.</span><span class="nv">version</span><span class="si">}</span><span class="s2">"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">nixLd</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">];</span>
</code></pre></div></div>

<p>The official documentation uses <code class="language-plaintext highlighter-rouge">LLVM_ENABLE_PROJECTS</code> to enable runtimes, which is deprecated, so I first removed that in favor of a manual two-stage build for libc++ and libc++abi.</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c"># For building clang itself, we're just using the compiler wrapper and we</span>
  <span class="c"># don't need to inject any flags of our own.</span>
  <span class="nv">cmakeFlags</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"-DGCC_INSTALL_PREFIX=</span><span class="si">${</span><span class="nv">gcc</span><span class="si">}</span><span class="s2">"</span>
    <span class="s2">"-DC_INCLUDE_DIRS=</span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="o">.</span><span class="nv">libc</span><span class="o">.</span><span class="nv">dev</span><span class="si">}</span><span class="s2">/include"</span>
    <span class="s2">"-DCMAKE_BUILD_TYPE=Release"</span>
    <span class="s2">"-DCMAKE_INSTALL_PREFIX=</span><span class="si">${</span><span class="nv">installdir</span><span class="si">}</span><span class="s2">"</span>
    <span class="s2">"-DLLVM_INSTALL_TOOLCHAIN_ONLY=ON"</span>
    <span class="s2">"-DLLVM_ENABLE_PROJECTS=clang"</span>
    <span class="s2">"-DLLVM_TARGETS_TO_BUILD=X86"</span>
  <span class="p">];</span>
  <span class="nv">cmakeCmd</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"export CC=</span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="si">}</span><span class="s2">/bin/gcc; export CXX=</span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="si">}</span><span class="s2">/bin/g++;"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">cmakeCurses</span><span class="si">}</span><span class="s2">/bin/cmake -B </span><span class="si">${</span><span class="nv">builddir</span><span class="si">}</span><span class="s2"> -S llvm"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">cmakeFlags</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">];</span>
</code></pre></div></div>

<p>To build clang itself, I activate the nix shell and build only clang:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cd </span>llvm-project
<span class="gp">$</span><span class="w"> </span>nix-shell
<span class="gp">$</span><span class="w"> </span><span class="nb">eval</span> <span class="s2">"</span><span class="nv">$cmakeCmd</span><span class="s2">"</span>
<span class="gp">$</span><span class="w"> </span>make <span class="nt">-C</span> build <span class="nt">-j</span> <span class="sb">`</span><span class="nb">nproc</span><span class="sb">`</span>
</code></pre></div></div>

<p>I didn’t use <code class="language-plaintext highlighter-rouge">LLVM_ENABLE_RUNTIMES</code> since I had trouble passing the CMake arguments to the runtime builds through the top-level build.
The purpose of <code class="language-plaintext highlighter-rouge">LLVM_ENABLE_RUNTIMES</code> is to build an LLVM project using the just-built clang/LLVM, however compile and link arguments are not passed to the runtime builds using the default <code class="language-plaintext highlighter-rouge">CMAKE_CXX_FLAGS</code> as I expected (or at least I was unable to get this to work).</p>

<p>Instead, I configured a seperate set of cmake arguments for the runtimes, and manually passed the just-built clang compiler as <code class="language-plaintext highlighter-rouge">CXX</code> to the runtime builds like so:</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">cmakeRuntimeFlags</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"-DCMAKE_CXX_FLAGS=</span><span class="se">\"</span><span class="si">${</span><span class="nv">flags</span><span class="si">}</span><span class="se">\"</span><span class="s2">"</span>
    <span class="s2">"-DLIBCXX_TEST_COMPILER_FLAGS=</span><span class="se">\"</span><span class="si">${</span><span class="nv">flags</span><span class="si">}</span><span class="se">\"</span><span class="s2">"</span>
    <span class="s2">"-DLIBCXX_TEST_LINKER_FLAGS=</span><span class="se">\"</span><span class="si">${</span><span class="nv">flags</span><span class="si">}</span><span class="se">\"</span><span class="s2">"</span>
    <span class="s2">"-DLLVM_ENABLE_RUNTIMES='libcxx;libcxxabi'"</span>
  <span class="p">];</span>
  <span class="nv">cmakeRtCmd</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"export CC=</span><span class="si">${</span><span class="nv">builddir</span><span class="si">}</span><span class="s2">/bin/clang; export CXX=</span><span class="si">${</span><span class="nv">builddir</span><span class="si">}</span><span class="s2">/bin/clang++;"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">cmakeCurses</span><span class="si">}</span><span class="s2">/bin/cmake -B </span><span class="si">${</span><span class="nv">builddir</span><span class="si">}</span><span class="s2">-rt -S runtimes"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">cmakeRuntimeFlags</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">];</span>
</code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cd </span>llvm-project
<span class="gp">$</span><span class="w"> </span><span class="nb">eval</span> <span class="s2">"</span><span class="nv">$cmakeRtCmd</span><span class="s2">"</span>
<span class="gp">$</span><span class="w"> </span>make <span class="nt">-C</span> build-rt <span class="nt">-j</span> <span class="sb">`</span><span class="nb">nproc</span><span class="sb">`</span>
</code></pre></div></div>

<h1 id="testing-linking-running">Testing, Linking, Running</h1>

<p>A huge issue with testing arose due to the way NixOS handles it’s dynamic loader.</p>

<p>When you use software in NixOS, it’s usually found somewhere in the <code class="language-plaintext highlighter-rouge">/run/current-system/sw/</code> prefix, while most software expects to be run from <code class="language-plaintext highlighter-rouge">/usr</code> or <code class="language-plaintext highlighter-rouge">/usr/local</code>, or it expects to be able to find key libraries under those prefixes (eg <code class="language-plaintext highlighter-rouge">libc.so</code>).</p>

<p>Instead, each software component has it’s own prefix under <code class="language-plaintext highlighter-rouge">/nix/store</code>, for example:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>which perl
<span class="go">/run/current-system/sw/bin/perl
</span><span class="gp">$</span><span class="w"> </span>file <span class="si">$(</span>which perl<span class="si">)</span>
<span class="go">/run/current-system/sw/bin/perl: symbolic link to 
    /nix/store/kpzx6f97583zbjyyd7b17rbv057l4vn2-perl-5.34.0/bin/perl
</span></code></pre></div></div>

<p>Each compiler must then know the correct locations of the standard libraries and software components, such as the dynamic loader, the standard C library, etc.
To acomplish this, Nix-provided compilers ship with <em>wrappers</em> that inject the required flags.</p>

<p>If I inspect my GNU compilers, we see that I’m not using <code class="language-plaintext highlighter-rouge">g++</code> directly:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>which g++
<span class="go">/nix/store/gkzmfpb04ddb7phzj8g9sl6saxzprssg-gcc-wrapper-10.3.0/bin/g++
</span><span class="gp">$</span><span class="w"> </span>file <span class="si">$(</span>which g++<span class="si">)</span>
<span class="go">/nix/store/gkzmfpb04ddb7phzj8g9sl6saxzprssg-gcc-wrapper-10.3.0/bin/g++:
  a /nix/store/v1d8l3zqnia3hccqd0701szhlx22g54z-bash-5.1-p8/bin/bash
  script, ASCII text executable
</span></code></pre></div></div>

<p>The actual compiler is found in a seperate prefix:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">grep</span> <span class="s1">'g++'</span> <span class="si">$(</span>which g++<span class="si">)</span> | <span class="nb">head</span> <span class="nt">-n1</span>
<span class="go">[[ "/nix/store/mrqrvina0lfgrvdzfyri7sw9vxy6pyms-gcc-10.3.0/bin/g++" = *++ ]] &amp;&amp; isCxx=1 || isCxx=0
</span></code></pre></div></div>

<p>On my current system, the true compiler is found under <code class="language-plaintext highlighter-rouge">/nix/store/mrqrvina0lfgrvdzfyri7sw9vxy6pyms-gcc-10.3.0</code>.</p>

<p>This becomes an issue with testing LLVM because the tests run executables built with the just-built <code class="language-plaintext highlighter-rouge">clang++</code>, not with the wrapped compiler!
That’s why we have to inject so many flags in our <code class="language-plaintext highlighter-rouge">shell.nix</code>.</p>

<p>When I initially ran <code class="language-plaintext highlighter-rouge">make check-cxx</code> to run the tests for libc++, I found errors like this:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">FileNotFoundError: [Errno 2]
    No such file or directory:
    '/home/asher/workspace/llvm-project/brt/libcxx/test/std/containers/sequences/deque/deque.modifiers/Output/erase_iter_iter.pass.cpp.dir/t.tmp.exe'
</span></code></pre></div></div>

<p>It <em>looks</em> like the tests rely on an executable that’s not there.
However, if I check that location:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>file /home/asher/workspace/llvm-project/brt/libcxx/test/std/containers/sequences/deque/deque.modifiers/Output/erase_iter_iter.pass.cpp.dir/t.tmp.exe
<span class="go">/home/asher/workspace/llvm-project/brt/libcxx/test/std/containers/sequences/deque/deque.modifiers/Output/erase_iter_iter.pass.cpp.dir/t.tmp.exe:
ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked,
interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, with debug_info, not stripped
</span></code></pre></div></div>

<p>the executable <em>was</em> built.</p>

<p>If I try to run it directly, it still appears to not exist:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>/home/asher/workspace/llvm-project/brt/libcxx/test/std/containers/sequences/deque/deque.modifiers/Output/erase_iter_iter.pass.cpp.dir/t.tmp.exe
<span class="go">bash: /home/asher/workspace/llvm-project/brt/libcxx/test/std/containers/sequences/deque/deque.modifiers/Output/erase_iter_iter.pass.cpp.dir/t.tmp.exe:
  No such file or directory
</span></code></pre></div></div>

<p><strong><em>What’s going on here?</em></strong></p>

<h2 id="dynamic-linker">Dynamic Linker</h2>

<p>If we return to the output of running <code class="language-plaintext highlighter-rouge">file</code> on our mysterious executable, we see it thinks its dynamic linker is <code class="language-plaintext highlighter-rouge">/lib64/ld-linux-x86-64.so.2</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked,
interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, with debug_info, not stripped
</code></pre></div></div>

<p>However, if we look for that file, it doesn’t exist:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>file /lib64/ld-linux-x86-64.so.2
<span class="go">/lib64/ld-linux-x86-64.so.2:
  cannot open `/lib64/ld-linux-x86-64.so.2'
  (No such file or directory)
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">patchelf</code> utility from the NixOS developers will tell us where the dynamic linker is for a given executable:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>patchelf <span class="nt">--print-interpreter</span> /path/to/llvm-test.exe
<span class="go">/lib64/ld-linux-x86-64.so.2
</span></code></pre></div></div>

<p>Again, our executable wasn’t built by a Nix compiler wrapper, it was built by the clang we just compiled ourselves.
What dynamic linker do other programs on this system use?</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>patchelf <span class="nt">--print-interpreter</span> <span class="si">$(</span>which bash<span class="si">)</span>
<span class="go">/nix/store/vjq3q7dq8vmc13c3py97v27qwizvq7fd-glibc-2.33-59/lib/ld-linux-x86-64.so.2
</span></code></pre></div></div>

<p>That’s right, everything on NixOS is built in its own prefix.
If we had used a compiler wrapper, the flags to tell the executable which linker to use would have been injected.</p>

<p>I found that the linker flag <code class="language-plaintext highlighter-rouge">--dynamic-linker</code> will set the dynamic linker path for a given executable, and it’s used here in GCC’s compiler wrapper:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">grep</span> <span class="s1">'dynamic-link'</span> <span class="si">$(</span>which g++<span class="si">)</span>
<span class="gp">        extraBefore+=("-Wl,-dynamic-linker=$</span>NIX_DYNAMIC_LINKER_x86_64_unknown_linux_gnu<span class="s2">")
</span></code></pre></div></div>

<p>I can’t quite figure out how <code class="language-plaintext highlighter-rouge">NIX_DYNAMIC_LINKER_x86_64_unknown_linux_gnu</code> is set other than that it’s set by the script in <code class="language-plaintext highlighter-rouge">$gcc_wrapper_prefix/nix-support/add-flags.sh</code>, but I did find the file <code class="language-plaintext highlighter-rouge">dynamic-linker</code> under that same prefix:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>file <span class="si">$(</span>which g++<span class="si">)</span>
<span class="go">/run/current-system/sw/bin/g++: symbolic link to
  /nix/store/gkzmfpb04ddb7phzj8g9sl6saxzprssg-gcc-wrapper-10.3.0/bin/g++
</span><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> /nix/store/gkzmfpb04ddb7phzj8g9sl6saxzprssg-gcc-wrapper-10.3.0
<span class="go">bin  nix-support
</span><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> /nix/store/gkzmfpb04ddb7phzj8g9sl6saxzprssg-gcc-wrapper-10.3.0/nix-support
<span class="go">add-flags.sh      cc-ldflags      libc-crt1-cflags  libcxx-ldflags  orig-libc-dev            utils.bash
add-hardening.sh  dynamic-linker  libc-ldflags      orig-cc         propagated-build-inputs
cc-cflags         libc-cflags     libcxx-cxxflags   orig-libc       setup-hook
</span></code></pre></div></div>

<p>So the file <code class="language-plaintext highlighter-rouge">$gcc_wrapper_prefix/nix-support/dynamic-linker</code> contains the path to the dynamic linker the compiler is using:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat</span> /nix/store/gkzmfpb04ddb7phzj8g9sl6saxzprssg-gcc-wrapper-10.3.0/nix-support/dynamic-linker
<span class="go">/nix/store/vjq3q7dq8vmc13c3py97v27qwizvq7fd-glibc-2.33-59/lib/ld-linux-x86-64.so.2
</span></code></pre></div></div>

<p>I’ll then use this in my <code class="language-plaintext highlighter-rouge">shell.nix</code> to get the path to the dynamic linker, and then pass that to clang for building the LLVM runtimes so the correct dynamic linker is used for executables built by clang:</p>
<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">dynLinker</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">fileContents</span> <span class="s2">"</span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="si">}</span><span class="s2">/nix-support/dynamic-linker"</span><span class="p">;</span>
  <span class="nv">flags</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">([</span>
    <span class="s2">"-Wno-unused-command-line-argument"</span>
    <span class="s2">"-Wl,--dynamic-linker=</span><span class="si">${</span><span class="nv">dynLinker</span><span class="si">}</span><span class="s2">"</span>
                          <span class="err">↑↑↑↑↑↑↑↑↑↑↑↑↑</span>
  <span class="p">]</span> <span class="o">++</span> <span class="nv">gccFlags</span> <span class="o">++</span> <span class="nv">libcFlags</span><span class="p">);</span>
</code></pre></div></div>

<p>I’ve also added <code class="language-plaintext highlighter-rouge">-Wno-unused-command-line-argument</code> to the compile flags so we’re not spammed with warnings every time a link directory or file directory I pass to the compiler invokation is ignored.</p>

<p>We can now finally run our tests.
Sometimes required binaries are still not found by lit, so I use the <code class="language-plaintext highlighter-rouge">cxx-test-depends</code> target to build test dependencies and then I run lit manually:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>make cxx-test-depends <span class="nt">-C</span> build-rt
<span class="gp">$</span><span class="w"> </span>./build/bin/llvm-lit ./libcxx
</code></pre></div></div>

<h1 id="full-config">Full Config</h1>

<p>I was able to find lots of information about nix from playing around in the nix repl and using tab completion, like this:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>nix repl
<span class="go">Welcome to Nix 2.4. Type :? for help.

</span><span class="gp">nix-repl&gt;</span><span class="w"> </span>pkgs <span class="o">=</span> import &lt;nixpkgs&gt; <span class="o">{}</span>
<span class="go">
</span><span class="gp">nix-repl&gt;</span><span class="w"> </span>pkgs.lib.concatStringsSep <span class="s2">" "</span> <span class="o">[</span><span class="s2">"one"</span> <span class="s2">"two"</span> <span class="s2">"three"</span><span class="o">]</span>
<span class="go">"one two three"

</span><span class="gp">nix-repl&gt;</span><span class="w"> </span>pkgs.stdenv.cc.&lt;TAB&gt;&lt;TAB&gt;
<span class="go">pkgs.stdenv.cc.__ignoreNulls                pkgs.stdenv.cc.libc_dev
pkgs.stdenv.cc.all                          pkgs.stdenv.cc.libc_lib
pkgs.stdenv.cc.args                         pkgs.stdenv.cc.man
pkgs.stdenv.cc.bintools                     pkgs.stdenv.cc.meta
</span><span class="c">...
</span><span class="go">
</span><span class="gp">nix-repl&gt;</span><span class="w"> </span><span class="s2">"</span><span class="k">${</span><span class="nv">pkgs</span><span class="p">.stdenv.cc.cc</span><span class="k">}</span><span class="s2">"</span>
<span class="go">"/nix/store/mrqrvina0lfgrvdzfyri7sw9vxy6pyms-gcc-10.3.0"

</span><span class="gp">nix-repl&gt;</span><span class="w"> </span>pkgs.lib.fileContents <span class="s2">"</span><span class="k">${</span><span class="nv">pkgs</span><span class="p">.stdenv.cc</span><span class="k">}</span><span class="s2">/nix-support/dynamic-linker"</span>
<span class="go">"/nix/store/vjq3q7dq8vmc13c3py97v27qwizvq7fd-glibc-2.33-59/lib/ld-linux-x86-64.so.2"
</span></code></pre></div></div>

<p>Here’s the full config:</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">with</span> <span class="kr">import</span> <span class="o">&lt;</span><span class="nv">nixpkgs</span><span class="o">&gt;</span> <span class="p">{};</span>

<span class="kd">let</span>
  <span class="nv">builddir</span> <span class="o">=</span> <span class="s2">"build"</span><span class="p">;</span>
  <span class="nv">installdir</span> <span class="o">=</span> <span class="s2">"install"</span><span class="p">;</span>
  <span class="nv">gccForLibs</span> <span class="o">=</span> <span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="o">.</span><span class="nv">cc</span><span class="p">;</span>
  <span class="nv">dynLinker</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">fileContents</span> <span class="s2">"</span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="si">}</span><span class="s2">/nix-support/dynamic-linker"</span><span class="p">;</span>
  <span class="nv">libcFlags</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"-L </span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="o">.</span><span class="nv">libc</span><span class="si">}</span><span class="s2">/lib"</span>
    <span class="s2">"-B </span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="o">.</span><span class="nv">libc</span><span class="si">}</span><span class="s2">/lib"</span>
    <span class="p">];</span>

  <span class="c"># The string version of just the gcc flags for NIX_LDFLAGS</span>
  <span class="nv">nixLd</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"-L </span><span class="si">${</span><span class="nv">gccForLibs</span><span class="si">}</span><span class="s2">/lib"</span>
    <span class="s2">"-L </span><span class="si">${</span><span class="nv">gccForLibs</span><span class="si">}</span><span class="s2">/lib/gcc/</span><span class="si">${</span><span class="nv">targetPlatform</span><span class="o">.</span><span class="nv">config</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">gccForLibs</span><span class="o">.</span><span class="nv">version</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">];</span>

  <span class="nv">gccFlags</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"-B </span><span class="si">${</span><span class="nv">gccForLibs</span><span class="si">}</span><span class="s2">/lib/gcc/</span><span class="si">${</span><span class="nv">targetPlatform</span><span class="o">.</span><span class="nv">config</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">gccForLibs</span><span class="o">.</span><span class="nv">version</span><span class="si">}</span><span class="s2">"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">nixLd</span><span class="si">}</span><span class="s2">"</span>
    <span class="p">];</span>

  <span class="nv">flags</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">([</span>
      <span class="s2">"-Wno-unused-command-line-argument"</span>
      <span class="s2">"-Wl,--dynamic-linker=</span><span class="si">${</span><span class="nv">dynLinker</span><span class="si">}</span><span class="s2">"</span>
    <span class="p">]</span> <span class="o">++</span> <span class="nv">gccFlags</span> <span class="o">++</span> <span class="nv">libcFlags</span><span class="p">);</span>

  <span class="c"># For building clang itself, we're just using the compiler wrapper and we</span>
  <span class="c"># don't need to inject any flags of our own.</span>
  <span class="nv">cmakeFlags</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"-DGCC_INSTALL_PREFIX=</span><span class="si">${</span><span class="nv">gcc</span><span class="si">}</span><span class="s2">"</span>
    <span class="s2">"-DC_INCLUDE_DIRS=</span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="o">.</span><span class="nv">libc</span><span class="o">.</span><span class="nv">dev</span><span class="si">}</span><span class="s2">/include"</span>
    <span class="s2">"-DCMAKE_BUILD_TYPE=Release"</span>
    <span class="s2">"-DCMAKE_INSTALL_PREFIX=</span><span class="si">${</span><span class="nv">installdir</span><span class="si">}</span><span class="s2">"</span>
    <span class="s2">"-DLLVM_INSTALL_TOOLCHAIN_ONLY=ON"</span>
    <span class="s2">"-DLLVM_ENABLE_PROJECTS=clang"</span>
    <span class="s2">"-DLLVM_TARGETS_TO_BUILD=X86"</span>
  <span class="p">];</span>

  <span class="c"># For configuring a build of LLVM runtimes however, we do need to inject the</span>
  <span class="c"># extra flags.</span>
  <span class="nv">cmakeRuntimeFlags</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"-DCMAKE_CXX_FLAGS=</span><span class="se">\"</span><span class="si">${</span><span class="nv">flags</span><span class="si">}</span><span class="se">\"</span><span class="s2">"</span>
    <span class="s2">"-DLIBCXX_TEST_COMPILER_FLAGS=</span><span class="se">\"</span><span class="si">${</span><span class="nv">flags</span><span class="si">}</span><span class="se">\"</span><span class="s2">"</span>
    <span class="s2">"-DLIBCXX_TEST_LINKER_FLAGS=</span><span class="se">\"</span><span class="si">${</span><span class="nv">flags</span><span class="si">}</span><span class="se">\"</span><span class="s2">"</span>
    <span class="s2">"-DLLVM_ENABLE_RUNTIMES='libcxx;libcxxabi'"</span>
  <span class="p">];</span>

  <span class="nv">cmakeCmd</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"export CC=</span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="si">}</span><span class="s2">/bin/gcc; export CXX=</span><span class="si">${</span><span class="nv">stdenv</span><span class="o">.</span><span class="nv">cc</span><span class="si">}</span><span class="s2">/bin/g++;"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">cmakeCurses</span><span class="si">}</span><span class="s2">/bin/cmake -B </span><span class="si">${</span><span class="nv">builddir</span><span class="si">}</span><span class="s2"> -S llvm"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">cmakeFlags</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">];</span>

  <span class="nv">cmakeRtCmd</span> <span class="o">=</span> <span class="nv">lib</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">[</span>
    <span class="s2">"export CC=</span><span class="si">${</span><span class="nv">builddir</span><span class="si">}</span><span class="s2">/bin/clang; export CXX=</span><span class="si">${</span><span class="nv">builddir</span><span class="si">}</span><span class="s2">/bin/clang++;"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">cmakeCurses</span><span class="si">}</span><span class="s2">/bin/cmake -B </span><span class="si">${</span><span class="nv">builddir</span><span class="si">}</span><span class="s2">-rt -S runtimes"</span>
    <span class="s2">"</span><span class="si">${</span><span class="nv">cmakeRuntimeFlags</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">];</span>

<span class="kn">in</span> <span class="nv">stdenv</span><span class="o">.</span><span class="nv">mkDerivation</span> <span class="p">{</span>

  <span class="nv">name</span> <span class="o">=</span> <span class="s2">"llvm-dev-env"</span><span class="p">;</span>

  <span class="nv">buildInputs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nv">bashInteractive</span>
    <span class="nv">cmakeCurses</span>
    <span class="nv">llvmPackages_latest</span><span class="o">.</span><span class="nv">llvm</span>
  <span class="p">];</span>

  <span class="c"># where to find libgcc</span>
  <span class="nv">NIX_LDFLAGS</span> <span class="o">=</span> <span class="s2">"</span><span class="si">${</span><span class="nv">nixLd</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

  <span class="c"># teach clang about C startup file locations</span>
  <span class="nv">CFLAGS</span> <span class="o">=</span> <span class="s2">"</span><span class="si">${</span><span class="nv">flags</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
  <span class="nv">CXXFLAGS</span> <span class="o">=</span> <span class="s2">"</span><span class="si">${</span><span class="nv">flags</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

  <span class="nv">cmakeRuntimeFlags</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">cmakeRuntimeFlags</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
  <span class="nv">cmakeFlags</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">cmakeFlags</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>

  <span class="nv">cmake</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">cmakeCmd</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
  <span class="nv">cmakeRt</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">cmakeRtCmd</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<font size="-1">
  <em>
    These views do not in any way represent those of NVIDIA or any other organization or institution that I am professionally associated with.
    These views are entirely my own.
  </em>
</font>


  </div>

  <hr>

  <div class="date">
    Written on Feb 2nd, 2022
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:ashermancinelli@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/ashermancinelli"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/https://www.linkedin.com/in/asher-mancinelli-bb4a56144/"><i class="svg-icon linkedin"></i></a>




<a href="https://youtube.com/channel/UCZ5sL4E662VP1ZwC4h85ttQ"><i class="svg-icon youtube"></i></a>

        </footer>
      </div>
    </div>
    
    <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a>
</div>
    
    

  </body>
</html>
